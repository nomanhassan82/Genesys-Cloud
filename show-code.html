<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Show Authorization Code</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { color-scheme: light dark; }
    body{font-family:system-ui,Arial,sans-serif;margin:24px;max-width:760px}
    #box{background:#f4f4f4;border-radius:12px;padding:16px;margin-top:12px}
    code{word-break:break-all}
    .err{color:#b00020}
    .ok{color:#0b7d2b}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    button{padding:.55rem .8rem;border:1px solid #bbb;border-radius:10px;cursor:pointer}
    pre{white-space:pre-wrap}
    .muted{opacity:.75}
  </style>
</head>
<body>
  <h1>Authorization Code Result</h1>
  <div id="box">Processing…</div>

  <script>
    const LS_STATE_KEY = "oauth:google:state";
    const LS_VERIF_KEY = "oauth:google:pkce_verifier";
    const LS_CLIENT_ID = "oauth:google:client_id";
    const LS_REDIRECT  = "oauth:google:redirect_uri";

    const box = document.getElementById("box");
    const url = new URL(location.href);
    const code  = url.searchParams.get("code");
    const state = url.searchParams.get("state");

    const savedState = localStorage.getItem(LS_STATE_KEY) || "";
    const verifier   = localStorage.getItem(LS_VERIF_KEY) || "";
    const clientId   = localStorage.getItem(LS_CLIENT_ID) || "";
    const redirectUri= localStorage.getItem(LS_REDIRECT)  || (location.origin + location.pathname);

    const jsonBlob = () => {
      const payload = {
        code,
        pkce_verifier: verifier,
        redirect_uri: redirectUri,
        client_id: clientId,
        state
      };
      return new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    };

    async function copy(text){
      try { await navigator.clipboard.writeText(text); alert("Copied!"); }
      catch(e){ console.error(e); alert("Copy failed. Select and copy manually."); }
    }

    function downloadJSON() {
      const blob = jsonBlob();
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "google-oauth-code-and-verifier.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    if (!code) {
      box.innerHTML = `<div class="err"><strong>Error:</strong> No <code>code</code> in query string.</div>`;
    } else if (!state || !savedState || state !== savedState) {
      box.innerHTML = `<div class="err"><strong>Error:</strong> Invalid <code>state</code>.</div>
        <div class="muted">Returned: <code>${state || "(none)"}</code></div>
        <div class="muted">Saved: <code>${savedState || "(none)"}</code></div>`;
    } else {
      // Clear state to prevent replays; keep verifier so you can use it
      localStorage.removeItem(LS_STATE_KEY);

      box.innerHTML = `
        <div class="ok"><strong>Success!</strong> You can now copy or download values.</div>

        <h3>Authorization code</h3>
        <pre><code id="codeVal">${code}</code></pre>
        <button id="copyCode">Copy code</button>

        <h3 style="margin-top:18px">PKCE verifier</h3>
        <pre><code id="verVal">${verifier || "(missing — you must start from get-code.html)"}</code></pre>
        <button id="copyVer" ${!verifier ? "disabled" : ""}>Copy verifier</button>

        <h3 style="margin-top:18px">Redirect URI used</h3>
        <pre><code id="redirVal">${redirectUri}</code></pre>
        <button id="copyRedir">Copy redirect_uri</button>

        <h3 style="margin-top:18px">Client ID</h3>
        <pre><code id="clientVal">${clientId || "(optional here, but useful server-side)"}</code></pre>
        <button id="copyClient" ${!clientId ? "disabled" : ""}>Copy client_id</button>

        <div class="row">
          <button id="download">Download JSON (code + verifier + redirect_uri + client_id + state)</button>
          <button id="clear">Clear verifier (cleanup)</button>
        </div>
        <p class="muted">Exchange the code on your backend with your client secret + this PKCE verifier.</p>
      `;

      document.getElementById("copyCode").onclick   = () => copy(code);
      document.getElementById("copyVer").onclick    = () => verifier && copy(verifier);
      document.getElementById("copyRedir").onclick  = () => copy(redirectUri);
      document.getElementById("copyClient").onclick = () => clientId && copy(clientId);
      document.getElementById("download").onclick   = downloadJSON;
      document.getElementById("clear").onclick      = () => {
        localStorage.removeItem(LS_VERIF_KEY);
        alert("Verifier cleared from localStorage.");
      };
    }
  </script>
</body>
</html>
